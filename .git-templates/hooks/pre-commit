#!/bin/bash
# Pre-commit hook to prevent personal and sensitive information from being committed

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Checking staged files for sensitive information..."

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Flag to track if we found issues
FOUND_ISSUES=0
FOUND_WARNINGS=0

# Check each staged file
for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        # Check for hardcoded home directory paths
        if grep -E "/Users/[^/]+|/home/[^/]+" "$FILE" > /dev/null 2>&1; then
            # Exclude acceptable patterns
            if ! grep -E "(/Users/\\\$USER|/Users/\\\$\{USER\}|/Users/\\\$HOME|~/|/home/\\\$USER|/home/\\\$HOME)" "$FILE" > /dev/null 2>&1; then
                MATCHES=$(grep -n -E "/Users/[^/]+|/home/[^/]+" "$FILE" | head -5)
                if [ -n "$MATCHES" ]; then
                    echo -e "${RED}ERROR: Found hardcoded home path in: $FILE${NC}"
                    echo "$MATCHES"
                    echo ""
                    FOUND_ISSUES=1
                fi
            fi
        fi

        # Check for API keys
        if grep -iE "(api[_-]?key|apikey|api[_-]?secret)\s*[:=]\s*['\"]?[a-zA-Z0-9_-]{20,}" "$FILE" | grep -v "your_api_key" | grep -v "API_KEY" | grep -v "apiKeyHelper" > /dev/null 2>&1; then
            MATCHES=$(grep -in -E "(api[_-]?key|apikey|api[_-]?secret)" "$FILE" | head -3)
            if [ -n "$MATCHES" ]; then
                echo -e "${RED}ERROR: Found API key in: $FILE${NC}"
                echo "$MATCHES"
                echo ""
                FOUND_ISSUES=1
            fi
        fi

        # Check for Anthropic/OpenAI API keys
        if grep -E "(sk-ant-[a-zA-Z0-9_-]{95,}|sk-[a-zA-Z0-9]{48})" "$FILE" > /dev/null 2>&1; then
            echo -e "${RED}ERROR: Found Anthropic/OpenAI API key in: $FILE${NC}"
            echo "  (API key pattern detected)"
            echo ""
            FOUND_ISSUES=1
        fi

        # Check for AWS credentials
        if grep -E "(AKIA[0-9A-Z]{16}|aws[_-]?access|aws[_-]?secret)" "$FILE" > /dev/null 2>&1; then
            MATCHES=$(grep -in -E "(AKIA[0-9A-Z]{16}|aws[_-]?access|aws[_-]?secret)" "$FILE" | head -3)
            if [ -n "$MATCHES" ]; then
                echo -e "${RED}ERROR: Found AWS credentials in: $FILE${NC}"
                echo "$MATCHES"
                echo ""
                FOUND_ISSUES=1
            fi
        fi

        # Check for private keys
        if grep -E "BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY" "$FILE" > /dev/null 2>&1; then
            echo -e "${RED}ERROR: Found private key in: $FILE${NC}"
            echo "  (Private key detected)"
            echo ""
            FOUND_ISSUES=1
        fi

        # Check for auth tokens
        if grep -iE "(auth[_-]?token|bearer[_-]?token|access[_-]?token|refresh[_-]?token)\s*[:=]\s*['\"]?[a-zA-Z0-9_-]{20,}" "$FILE" | grep -v "your_token" > /dev/null 2>&1; then
            MATCHES=$(grep -in -E "(auth[_-]?token|bearer|access[_-]?token|refresh[_-]?token)" "$FILE" | head -3)
            if [ -n "$MATCHES" ]; then
                echo -e "${RED}ERROR: Found auth token in: $FILE${NC}"
                echo "$MATCHES"
                echo ""
                FOUND_ISSUES=1
            fi
        fi

        # Check for passwords (with context)
        if grep -E "(password|passwd|pwd)\s*[:=]\s*['\"][^'\"]{3,}" "$FILE" | grep -v "your_password" | grep -v "password:" | grep -v "# password" > /dev/null 2>&1; then
            MATCHES=$(grep -in -E "(password|passwd|pwd)\s*[:=]" "$FILE" | grep -v "your_password" | head -3)
            if [ -n "$MATCHES" ]; then
                echo -e "${RED}ERROR: Found password in: $FILE${NC}"
                echo "$MATCHES"
                echo ""
                FOUND_ISSUES=1
            fi
        fi

        # Check for personal email (non-GitHub noreply) - warning only
        if grep -E "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" "$FILE" | grep -v "noreply.github.com" | grep -v "example.com" | grep -v "your@email.com" | grep -v "@anthropic.com" | grep -v "git@github.com" > /dev/null 2>&1; then
            MATCHES=$(grep -n -E "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" "$FILE" | grep -v "noreply.github.com" | grep -v "example.com" | grep -v "your@email.com" | grep -v "@anthropic.com" | grep -v "git@github.com" | head -3)
            if [ -n "$MATCHES" ]; then
                echo -e "${YELLOW}WARNING: Found email address in: $FILE${NC}"
                echo "$MATCHES"
                echo -e "${YELLOW}   (Verify this should be public)${NC}"
                echo ""
                FOUND_WARNINGS=1
            fi
        fi
    fi
done

# If we found critical issues, prevent the commit
if [ $FOUND_ISSUES -eq 1 ]; then
    echo -e "${RED}================================${NC}"
    echo -e "${RED}COMMIT BLOCKED${NC}"
    echo -e "${RED}Sensitive information detected in staged files.${NC}"
    echo -e "${RED}================================${NC}"
    echo ""
    echo "Suggestions:"
    echo "  1. Replace hardcoded paths with \$HOME or ~"
    echo "  2. Move secrets to .env or gitignored files"
    echo "  3. Use environment variables for credentials"
    echo "  4. Never commit API keys or private keys"
    echo ""
    echo "To bypass this check (not recommended):"
    echo "  git commit --no-verify"
    exit 1
fi

# Only show success message if there were no warnings either
if [ $FOUND_WARNINGS -eq 0 ]; then
    echo "No sensitive information detected. Proceeding with commit."
else
    echo "Warnings found but proceeding with commit."
fi
exit 0
